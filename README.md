# Superkube

A reproducible local Kubernetes development environment using kind + Flux GitOps, with a baseline set of essential services installed declaratively.

## Overview

Superkube provides a fully automated setup for a local Kubernetes cluster with:
- **kind** for the local Kubernetes cluster
- **Flux** for GitOps-based continuous deployment
- **Baseline components** managed via Helm charts:
  - ingress-nginx - Ingress controller for routing external traffic
  - cert-manager - Certificate management
  - metrics-server - Resource metrics for autoscaling

## Prerequisites

### Required
- **Docker** - Container runtime (must be installed manually)
  - Ubuntu/Debian: `sudo apt install docker.io -y && sudo usermod -aG docker $USER`
  - Then log out and log back in for group changes to take effect
- **Ansible** - Automation tool
  - Ubuntu/Debian: `sudo apt install ansible -y`
- **GitHub Personal Access Token** - For Flux GitOps
  - Create at: https://github.com/settings/tokens
  - Required scopes: `repo` (full control of private repositories)
  - Export as environment variable: `export GITHUB_TOKEN=<your-token>`

### Auto-Installed
The bootstrap process automatically installs these if missing:
- kubectl (v1.28.0)
- kind (v0.20.0)
- flux CLI (v2.2.0)
- helm (v3.x)

## Quick Start

### 1. Set GitHub Token

```bash
export GITHUB_TOKEN=<your-github-personal-access-token>
```

### 2. Bootstrap the Cluster

```bash
make up
```

This will:
1. Verify/install prerequisites (kubectl, kind, flux, helm)
2. Create a kind cluster with port mappings (80:80, 443:443)
3. Bootstrap Flux pointing to this repository
4. Deploy all baseline applications via GitOps

The process takes 5-10 minutes on first run.

### 3. Verify Installation

```bash
make status
```

Expected output should show:
- Cluster running with 1 control-plane node
- Flux system pods in `Running` state
- All HelmReleases in `Ready` state
- Application pods running in their respective namespaces

## Available Commands

### `make help`
Display all available commands

### `make up`
Bootstrap the complete superkube environment:
- Check prerequisites
- Install missing tools
- Create kind cluster
- Bootstrap Flux
- Deploy all applications

### `make down`
Completely destroy the cluster and clean up resources

### `make status`
Show comprehensive status of:
- Cluster info
- Nodes
- Flux system
- Kustomizations
- Helm releases
- Application pods

### `make check-prerequisites`
Verify all required prerequisites are met without making changes

## Architecture

### Directory Structure

```
superkube/
├── ansible/
│   └── playbooks/
│       ├── bootstrap.yml    # Cluster creation and Flux setup
│       └── destroy.yml      # Cluster deletion
├── kind/
│   └── kind-config.yaml     # Kind cluster configuration
├── clusters/
│   └── dev/
│       ├── flux-system/     # Auto-generated by Flux bootstrap
│       └── kustomization.yaml  # Points to gitops/ folder
├── gitops/
│   ├── sources/             # HelmRepository definitions
│   │   ├── ingress-nginx.yaml
│   │   ├── cert-manager.yaml
│   │   └── metrics-server.yaml
│   ├── releases/            # HelmRelease definitions
│   │   ├── ingress-nginx.yaml
│   │   ├── cert-manager.yaml
│   │   └── metrics-server.yaml
│   └── kustomization.yaml   # Kustomization for all resources
├── Makefile                 # Automation commands
└── README.md               # This file
```

### Installed Components

#### ingress-nginx (v4.8.3)
- **Namespace**: `ingress-nginx`
- **Chart Source**: https://kubernetes.github.io/ingress-nginx
- **Purpose**: Routes external HTTP/HTTPS traffic to services
- **Configuration**: DaemonSet mode with host network for kind compatibility

#### cert-manager (v1.13.3)
- **Namespace**: `cert-manager`
- **Chart Source**: https://charts.jetstack.io
- **Purpose**: Automated certificate management and renewal
- **Configuration**: CRDs installation enabled

#### metrics-server (v3.11.0)
- **Namespace**: `kube-system`
- **Chart Source**: https://kubernetes-sigs.github.io/metrics-server/
- **Purpose**: Cluster-wide resource metrics for kubectl top and HPA
- **Configuration**: Insecure TLS mode for kind compatibility

## GitOps Workflow

### How It Works

1. **Flux Bootstrap**: Installs Flux components in `flux-system` namespace
2. **GitRepository**: Flux watches this GitHub repository for changes
3. **Kustomization**: Flux applies manifests from `clusters/dev/` and `gitops/`
4. **HelmRepository**: Defines Helm chart repositories
5. **HelmRelease**: Declares desired state of Helm installations
6. **Reconciliation**: Flux continuously syncs cluster state with Git

### Making Changes

All changes to applications should be made through Git:

1. **Update a chart version**: Edit the version in `gitops/releases/*.yaml`
2. **Change configuration**: Edit values in the `values:` section
3. **Commit and push**: Flux will automatically detect and apply changes
4. **Verify**: Use `make status` or `flux get helmreleases -A`

### Adding New Applications

1. **Create HelmRepository** (if new chart repo):
   ```yaml
   # gitops/sources/myapp.yaml
   apiVersion: source.toolkit.fluxcd.io/v1beta2
   kind: HelmRepository
   metadata:
     name: myapp
     namespace: flux-system
   spec:
     interval: 10m
     url: https://charts.example.com
   ```

2. **Create HelmRelease**:
   ```yaml
   # gitops/releases/myapp.yaml
   apiVersion: helm.toolkit.fluxcd.io/v2beta1
   kind: HelmRelease
   metadata:
     name: myapp
     namespace: flux-system
   spec:
     interval: 10m
     chart:
       spec:
         chart: myapp
         version: 1.0.0
         sourceRef:
           kind: HelmRepository
           name: myapp
           namespace: flux-system
     targetNamespace: myapp
     values:
       # Your values here
   ```

3. **Update kustomization.yaml**:
   ```yaml
   # Add to gitops/kustomization.yaml
   resources:
     - sources/myapp.yaml
     - releases/myapp.yaml
   ```

4. **Commit and push**: Flux will reconcile automatically

## Troubleshooting

### Cluster won't start
```bash
# Check Docker is running
docker ps

# Check kind logs
kind get clusters
docker logs superkube-control-plane
```

### Flux not reconciling
```bash
# Check Flux system status
kubectl get pods -n flux-system

# Check reconciliation status
flux get sources git -A
flux get kustomizations -A

# Force reconciliation
flux reconcile kustomization flux-system --with-source
flux reconcile kustomization superkube-apps --with-source
```

### HelmRelease fails
```bash
# Check HelmRelease status
kubectl describe helmrelease <name> -n flux-system

# Check Helm controller logs
kubectl logs -n flux-system -l app=helm-controller -f

# Force reconciliation
flux reconcile helmrelease <name> -n flux-system
```

### Port conflicts (80/443 already in use)
```bash
# Find what's using the ports
sudo lsof -i :80
sudo lsof -i :443

# Stop the conflicting service or modify kind-config.yaml to use different ports
```

## Upgrading Components

### Upgrade Chart Versions

1. Check for new versions:
   ```bash
   # For ingress-nginx
   helm search repo ingress-nginx/ingress-nginx --versions | head

   # For cert-manager
   helm search repo jetstack/cert-manager --versions | head

   # For metrics-server
   helm search repo metrics-server/metrics-server --versions | head
   ```

2. Update version in `gitops/releases/<component>.yaml`

3. Commit and push - Flux will automatically upgrade

### Upgrade Flux

```bash
# Check current version
flux version

# Upgrade Flux CLI (if needed)
curl -s https://fluxcd.io/install.sh | sudo bash

# Upgrade Flux in cluster
flux install --export > /tmp/flux-system.yaml
kubectl apply -f /tmp/flux-system.yaml
```

## Cleaning Up

### Temporary Cleanup (preserve configuration)
```bash
make down
# Deletes the cluster but keeps all files
```

### Complete Cleanup
```bash
make down
# Then manually uninstall tools if desired:
# sudo rm /usr/local/bin/{kubectl,kind,flux,helm}
```

## Development Notes

- **Cluster Name**: `superkube`
- **Context**: `kind-superkube`
- **Flux Path**: `clusters/dev`
- **GitOps Path**: `gitops/`

## Resources

- [kind Documentation](https://kind.sigs.k8s.io/)
- [Flux Documentation](https://fluxcd.io/docs/)
- [ingress-nginx](https://kubernetes.github.io/ingress-nginx/)
- [cert-manager](https://cert-manager.io/)
- [metrics-server](https://github.com/kubernetes-sigs/metrics-server)

## License

This project is open source and available under the MIT License.
